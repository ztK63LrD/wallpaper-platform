"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../api/preview.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const u={__name:"preview",setup(u){const o=e.ref(!0),i=e.ref(),n=e.ref(),t=e.ref(0),s=e.ref(null),v=e.ref(0),r=e.ref([]),c=e.ref(null),d=e.ref([]),p=e.ref(!1);let m=e.ref([{name:"信息",icon:"info",color:"orange"},{name:"评分",icon:"star",color:"yellow"},{name:"下载",icon:"download",color:"green"}]),f=e.ref([{label:"壁纸ID:",value:"52315631563"},{label:"发布者:",value:"author"},{label:"评分:",value:"5分"},{label:"摘要:",value:"52315123123"},{label:"标签:",tabs:["标签名","标签名","标签名"]}]);const h=e.index.getStorageSync("storgClassList")||[];d.value=h.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})));const g=()=>{r.value.push(v.value<=0?d.value.length-1:v.value-1,v.value,v.value>=d.value.length-1?0:v.value+1),r.value=[...new Set(r.value)]};e.onLoad((async e=>{if(s.value=e.id,"share"==e.type){let e=await l.apiDetailWall({id:s.value});d.value=e.data.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})))}v.value=d.value.findIndex((e=>e._id==s.value)),c.value=d.value[v.value],c.value&&(m.value[1].name=c.value.score+"分",f.value[0].value=c.value._id,f.value[1].value=c.value.nickname,f.value[2].value=c.value.score+"分",f.value[3].value=c.value.description,f.value[4].tabs=c.value.tabs),g()}));const b=e=>{v.value=e.detail.current,c.value=d.value[v.value],c.value&&(m.value[1].name=c.value.score+"分",f.value[0].value=c.value._id,f.value[1].value=c.value.nickname,f.value[2].value=c.value.score+"分",f.value[3].value=c.value.description,f.value[4].tabs=c.value.tabs),g()},w=()=>{e.index.navigateBack({success:()=>{e.index.navigateBack()},fail:a=>{e.index.reLaunch({url:"/pages/index/index"})}})},x=()=>{o.value=!o.value},y=()=>{i.value.close()},_=()=>{n.value.close(),t.value=0,p.value=!1},S=async()=>{e.index.showLoading({title:"加载中..."});let{classid:a,_id:u}=c.value,o=await l.apiSetupScore({classid:a,wallId:u,userScore:t.value});e.index.hideLoading(),0===o.errCode&&(e.index.showToast({title:"评分成功",icon:"none"}),d.value[v.value].userScore=t.value,e.index.setStorageSync("storgClassList",d.value),_())};return e.onShareAppMessage((e=>({title:"看我分享的图片",path:"/pages/preview/preview?id="+s.value+"&type=share"}))),e.onShareTimeline((()=>({title:"朋友圈分享啦",query:"id="+s.value+"&type=share"}))),(u,s)=>e.e({a:c.value},c.value?{b:e.f(d.value,((a,l,u)=>e.e({a:r.value.includes(l)},r.value.includes(l)?{b:e.o(x,a._id),c:a.picurl}:{},{d:a._id}))),c:v.value,d:e.o(b),e:e.p({type:"back",size:"24",color:"#fff"}),f:e.unref(a.getStatusBarHeight)()+"px",g:e.o(w),h:e.t(v.value+1),i:e.t(d.value.length),j:e.p({date:new Date,format:"hh:mm"}),k:e.p({date:new Date,format:"MM月dd日"}),l:e.f(e.unref(m),((a,u,o)=>({a:"061972e2-3-"+o,b:e.p({type:a.icon,size:"28",color:a.color}),c:e.t(a.name),d:a,e:e.o((u=>(async a=>{if("信息"==a)i.value.open();else if(a.includes("分"))c.value.userScore&&(p.value=!0,t.value=c.value.userScore),n.value.open();else if("下载"==a)try{e.index.showLoading({title:"下载中...",mask:!0});let{classid:a,_id:u}=c.value,o=await l.apiWriteDownload({classid:a,wallId:u});if(0!=o.errCode)throw o;e.index.getImageInfo({src:c.value.picurl,success:a=>{e.index.saveImageToPhotosAlbum({filePath:a.path,success(a){e.index.showToast({title:"保存成功，请到相册查看",icon:"none"})},fail:a=>{"saveTmageToPhotosAlbum:fail cancel"!==a.errMsg?e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:a=>{a.confirm&&e.index.openSetting({success:a=>{a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取权限失败",icon:"none"})}})}}):e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"})},complete:()=>{e.index.hideLoading()}})}})}catch(u){e.index.hideLoading()}})(a.name)),a)}))),m:o.value,n:e.p({type:"closeempty",size:"18",color:"#999"}),o:e.o(y),p:e.f(e.unref(f),((a,l,u)=>e.e({a:e.t(a.label),b:"评分:"==a.label},"评分:"==a.label?{c:"061972e2-6-"+u+",061972e2-4",d:e.p({readonly:!0,touchable:!0,value:"3.5",size:"16"}),e:e.t(a.value)}:"标签:"==a.label?{g:e.f(a.tabs,((a,l,u)=>({a:e.t(a),b:a})))}:{h:e.t(a.value)},{f:"标签:"==a.label,i:a}))),q:e.sr(i,"061972e2-4",{k:"infoPopup"}),r:e.p({type:"bottom","safe-area":!1}),s:e.t(p.value?"评分过了~":"壁纸评分"),t:e.p({type:"closeempty",size:"18",color:"#999"}),v:e.o(_),w:e.o((e=>t.value=e)),x:e.p({allowHalf:!0,disabled:p.value,"disabled-color":"#FFCA3E",modelValue:t.value}),y:e.t(t.value),z:e.o(S),A:!t.value||p.value,B:e.sr(n,"061972e2-7",{k:"scorePopup"}),C:e.p({"is-mask-click":!1})}:{})}},o=e._export_sfc(u,[["__scopeId","data-v-061972e2"]]);u.__runtimeHooks=6,wx.createPage(o);
